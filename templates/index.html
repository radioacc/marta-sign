<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Tracker</title>
    <style>
        :root { --bg: #ffffff; --text: #000000; --header-bg: #000000; --row-border: #eeeeee; --modal-bg: #ffffff; }
        body.dark-mode { --bg: #121212; --text: #e0e0e0; --header-bg: #1f1f1f; --row-border: #333333; --modal-bg: #222222; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; }
        header { background-color: var(--header-bg); color: #fff; height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 10; }
        .station-display { font-size: 1.5rem; font-weight: 700; text-align: center; flex-grow: 1; }
        .station-display span { display: block; font-size: 0.7rem; color: #ccc; }
        main { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .train-row { display: flex; align-items: center; border-bottom: 1px solid var(--row-border); padding-bottom: 15px; margin-bottom: 20px; }
        .line-bubble { width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; color: #fff; margin-right: 15px; }
        .RED { background-color: #ED1C24; } .GOLD { background-color: #FFA500; } .BLUE { background-color: #009DDC; } .GREEN { background-color: #69BE28; }
        .destination { font-size: 1.8rem; font-weight: 700; }
        .minutes-box { text-align: right; min-width: 100px; margin-left: auto; }
        .minutes-main { font-size: 2rem; font-weight: 700; }
        .minutes-sub { font-size: 0.8rem; color: #666; text-transform: uppercase; }
        
        #theme-toggle { position: fixed; bottom: 20px; right: 20px; cursor: pointer; font-size: 2rem; z-index: 1000; }
        button.nav-btn { background-color: #333; color: #fff; border: 1px solid #555; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; margin-left: 5px; }

        /* Theme-Matched Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--modal-bg); color: var(--text); width: 90%; max-width: 400px; max-height: 70vh; overflow-y: auto; border-radius: 8px; padding: 20px; border: 1px solid var(--row-border); }
        .list-item { display: block; width: 100%; padding: 15px; text-align: left; border-bottom: 1px solid var(--row-border); background: none; color: var(--text); cursor: pointer; font-size: 1.1rem; }
        .list-item:hover { background: rgba(128,128,128,0.1); }
    </style>
</head>
<body class="dark-mode">

    <header>
        <div class="station-display" id="headerText">
            <span>ARRIVING AT</span>
            {{ initial_station }}
        </div>
        <div class="controls">
            <button class="nav-btn" onclick="openModal('filterModal')">FILTER</button>
            <button class="nav-btn" onclick="openModal('stationModal')">STATION</button>
        </div>
    </header>

    <main id="container">
        <div style="text-align:center; padding: 50px; opacity: 0.5; font-size: 1.2rem;">Fetching Train Data...</div>
    </main>

    <div id="theme-toggle" onclick="toggleTheme()">üåô</div>

    <div class="modal-overlay" id="stationModal">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">Select Station</h3>
            {% for s in stations %}
            <button class="list-item" onclick="changeStation('{{ s }}')">{{ s|title }}</button>
            {% endfor %}
            <button class="nav-btn" style="width:100%; margin-top:15px;" onclick="closeModal('stationModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="filterModal">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">Filter Destination</h3>
            <div id="filterList">
                <button class="list-item" onclick="setFilter('ALL')">Show All</button>
            </div>
            <button class="nav-btn" style="width:100%; margin-top:15px;" onclick="closeModal('filterModal')">Close</button>
        </div>
    </div>

    <script>
        let currentStation = "{{ initial_station }}";
        let activeFilter = "ALL";
        let trainData = [];

        async function fetchTrains() {
            try {
                const res = await fetch(`/api/arrivals?station=${currentStation}`);
                trainData = await res.json();
                rebuildFilterMenu();
                render();
            } catch (e) {
                document.getElementById('container').innerHTML = '<div style="text-align:center; padding:50px;">Connection Error</div>';
            }
        }

        function render() {
            const container = document.getElementById('container');
            container.innerHTML = '';
            const filtered = trainData.filter(t => activeFilter === "ALL" || t.destination.toUpperCase() === activeFilter.toUpperCase());

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px;">No trains matching criteria</div>';
                return;
            }

            filtered.forEach(t => {
                let main = t.waiting_time;
                let sub = "MIN";
                
                if (main === "Arriving" || main === "0") { main = "ARR"; sub = "BOARDING"; }
                else if (main === "Boarding") { main = "BRD"; sub = "DEPARTING"; }
                else { main = main.replace(' min', ''); }

                container.innerHTML += `
                    <div class="train-row">
                        <div class="line-bubble ${t.line}">${t.direction}</div>
                        <div><div class="destination">${t.destination}</div></div>
                        <div class="minutes-box">
                            <div class="minutes-main">${main}</div>
                            <div class="minutes-sub">${sub}</div>
                        </div>
                    </div>`;
            });
        }

        function rebuildFilterMenu() {
            const list = document.getElementById('filterList');
            const dests = [...new Set(trainData.map(t => t.destination.toUpperCase()))].sort();
            list.innerHTML = '<button class="list-item" onclick="setFilter(\'ALL\')">Show All</button>';
            dests.forEach(d => {
                list.innerHTML += `<button class="list-item" onclick="setFilter('${d}')">${d}</button>`;
            });
        }

        function setFilter(f) { activeFilter = f; closeModal('filterModal'); render(); }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('theme-toggle').innerText = isDark ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function changeStation(s) {
            currentStation = s;
            document.getElementById('headerText').innerHTML = `<span>ARRIVING AT</span>${s}`;
            closeModal('stationModal');
            document.getElementById('container').innerHTML = '<div style="text-align:center; padding:50px;">Fetching Train Data...</div>';
            fetchTrains();
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        const saved = localStorage.getItem('theme');
        if (saved === 'light') { document.body.classList.remove('dark-mode'); document.getElementById('theme-toggle').innerText = '‚òÄÔ∏è'; }
        
        fetchTrains();
        setInterval(fetchTrains, 15000);
    </script>
</body>
</html>
