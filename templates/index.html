<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MARTA Trains</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/MARTA-logo.png') }}">
    <style>
        /* --- RESET & BASICS --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: white; 
            color: black; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- DARK MODE --- */
        body.dark-mode { background-color: #121212; color: #e0e0e0; }
        body.dark-mode header { background-color: #1f1f1f; border-bottom: 1px solid #333; }
        body.dark-mode .train-row { border-bottom: 1px solid #333; }
        body.dark-mode .minutes-sub { color: #888; }
        body.dark-mode button.nav-btn { background-color: #333; border: 1px solid #555; color: #eee; }
        body.dark-mode button.nav-btn:hover { background-color: #555; }
        body.dark-mode .modal-content { background-color: #222; color: #eee; border: 1px solid #444; }
        body.dark-mode .modal-header { background-color: #2a2a2a; border-bottom: 1px solid #444; }
        body.dark-mode .list-item { color: #eee; border-bottom: 1px solid #444; }
        body.dark-mode .list-item:hover { background-color: #333; }
        
        /* New Sun/Moon Toggle Styles */
        #theme-toggle {
            position: fixed; bottom: 15px; right: 15px; width: 40px; height: 40px;
            cursor: pointer; z-index: 200; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.1); border-radius: 50%; transition: background 0.3s;
        }
        #theme-toggle:hover { background: rgba(0,0,0,0.2); }
        body.dark-mode #theme-toggle { background: rgba(255,255,255,0.1); }
        body.dark-mode #theme-toggle:hover { background: rgba(255,255,255,0.2); }

        /* --- HEADER --- */
        header { 
            background-color: black; color: white; height: 70px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 20px; flex-shrink: 0; z-index: 10;
        }

        .brand { font-size: 1.8rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; width: 100px; }
        .station-display {
            font-size: 1.5rem; font-weight: 700; text-align: center; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis; flex-grow: 1; padding: 0 10px;
        }
        .station-display span {
            display: block; font-size: 0.7rem; font-weight: 400; text-transform: uppercase;
            letter-spacing: 1px; color: #ccc; margin-bottom: -2px;
        }

        .controls { display: flex; gap: 10px; width: 100px; justify-content: flex-end; align-items: center; }

        button.nav-btn {
            background-color: #333; color: white; border: 1px solid #555;
            padding: 8px 12px; border-radius: 4px; font-size: 0.9rem;
            font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        button.nav-btn:hover { background-color: #555; }

        /* --- MAIN LIST --- */
        main { flex-grow: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }

        .train-row { 
            display: flex; align-items: center; justify-content: space-between; 
            margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; height: 80px; 
        }
        
        .line-bubble { 
            width: 60px; height: 60px; border-radius: 50%; display: flex; 
            justify-content: center; align-items: center; font-size: 2rem; 
            font-weight: bold; color: white; margin-right: 20px; flex-shrink: 0; 
        }
        .line-bubble.RED { background-color: #ED1C24; }
        .line-bubble.GOLD { background-color: #FFA500; }
        .line-bubble.BLUE { background-color: #009DDC; }
        .line-bubble.GREEN { background-color: #69BE28; }
        .line-bubble.GRAY { background-color: #999; }

        .train-info { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .destination { 
            font-size: 2.8rem; font-weight: 700; white-space: nowrap; 
            overflow: hidden; text-overflow: ellipsis; letter-spacing: -1px; line-height: 1;
        }
        
        .minutes-box { 
            text-align: right; min-width: 120px; display: flex; 
            flex-direction: column; align-items: flex-end; justify-content: center;
        }
        .minutes-main { font-size: 2.8rem; font-weight: 700; line-height: 1; }
        .minutes-sub { font-size: 0.9rem; color: #666; margin-top: 4px; text-transform: uppercase; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); z-index: 100; display: none; 
            align-items: center; justify-content: center; backdrop-filter: blur(3px);
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; width: 90%; max-width: 450px; max-height: 80vh;
            border-radius: 8px; display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 20px; border-bottom: 2px solid #eee; display: flex;
            justify-content: space-between; align-items: center;
            background: #f9f9f9; border-radius: 8px 8px 0 0;
        }
        .close-btn { background: transparent; border: none; font-size: 2rem; color: #888; cursor: pointer; }
        .modal-list { overflow-y: auto; padding: 10px; }
        .list-item {
            display: block; width: 100%; text-align: left; padding: 15px 20px;
            background: transparent; border: none; border-bottom: 1px solid #eee;
            color: #333; font-size: 1.1rem; font-weight: 500; cursor: pointer;
        }

        @media (max-width: 600px) {
            header { height: 60px; padding: 0 15px; }
            .brand { display: none; } 
            .station-display { font-size: 1.1rem; text-align: left; }
            .destination { font-size: 1.6rem; }
            .minutes-main { font-size: 1.6rem; }
            .minutes-box { min-width: 80px; }
        }
    </style>
</head>
<body class="dark-mode">

    <header>
        <div class="brand">TRAINS</div>
        <div class="station-display" id="headerStationText">
            <span>ARRIVING AT</span>
            LOADING...
        </div>
        <div class="spinner" id="loadingSpinner"></div>
        <div class="controls">
            <button class="nav-btn" onclick="openModal('filterModal')">FILTER</button>
            <button class="nav-btn" onclick="openModal('stationModal')">STATION</button>
        </div>
    </header>

    <main id="trainContainer">
        <div style="text-align:center; padding: 50px; opacity: 0.5; font-size: 1.5rem;">Loading Schedule...</div>
    </main>

    <div id="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon" style="font-size: 24px;">üåô</span>
    </div>

    <div class="modal-overlay" id="stationModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Select Station</span>
                <button class="close-btn" onclick="closeModal('stationModal')">&times;</button>
            </div>
            <div class="modal-list">
                {% for s in stations %}
                <button class="list-item" onclick="changeStation('{{ s }}', true)">{{ s|title }}</button>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Filter Destination</span>
                <button class="close-btn" onclick="closeModal('filterModal')">&times;</button>
            </div>
            <div class="modal-list" id="filterListContainer">
                <button class="list-item" onclick="setFilter('ALL')">Show All</button>
            </div>
        </div>
    </div>

    <script>
        let currentStation = "{{ initial_station }}";
        let activeFilter = "ALL";
        let trainData = [];

        const container = document.getElementById('trainContainer');
        const headerText = document.getElementById('headerStationText');
        const themeIcon = document.getElementById('theme-icon');

        document.addEventListener('DOMContentLoaded', () => {
            fetchTrains();
            setInterval(fetchTrains, 15000);
            updateHeader();
            initTheme();
        });

        async function fetchTrains() {
            try {
                const response = await fetch(`/api/arrivals?station=${currentStation}`);
                const data = await response.json();
                trainData = data;
                rebuildFilterMenu();
                renderTrains();
            } catch (err) {
                console.error("Fetch error", err);
            }
        }

        function renderTrains() {
            container.innerHTML = ''; 
            const visibleTrains = trainData.filter(t => activeFilter === "ALL" || t.destination === activeFilter);

            if (visibleTrains.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding: 50px; opacity:0.5; font-size: 1.5rem;">No trains found.</div>`;
                return;
            }

            visibleTrains.forEach(t => {
                const row = document.createElement('div');
                row.className = `train-row`;
                
                let mainTime = t.waiting_time;
                let subLabel = "MIN";

                // Updated logic for Arriving, Boarding, and Departing
                if (mainTime === "Arriving") {
                    mainTime = "ARR"; 
                    subLabel = "BOARDING";
                } else if (mainTime === "Boarding") {
                    mainTime = "BRD"; 
                    subLabel = "DEPARTING";
                } else if (mainTime === "0") {
                    mainTime = "BRD";
                    subLabel = "DEPARTING";
                } else {
                    mainTime = mainTime.replace(' min', '');
                }

                row.innerHTML = `
                    <div class="line-bubble ${t.line}">${t.direction}</div>
                    <div class="train-info">
                        <div class="destination">${t.destination}</div>
                    </div>
                    <div class="minutes-box">
                        <div class="minutes-main">${mainTime}</div>
                        <div class="minutes-sub">${subLabel}</div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function changeStation(newStation, isManual) {
            currentStation = newStation;
            activeFilter = 'ALL';
            closeModal('stationModal');
            updateHeader();
            fetchTrains();
        }

        function setFilter(val) { activeFilter = val; closeModal('filterModal'); renderTrains(); }
        
        function updateHeader() {
            const display = currentStation.replace(/ STATION/i, '');
            headerText.innerHTML = `<span>ARRIVING AT</span>${display}`;
        }

        /* --- THEME LOGIC --- */
        function initTheme() {
            const savedTheme = localStorage.getItem('marta_theme');
            if (savedTheme === 'light') {
                document.body.classList.remove('dark-mode');
                themeIcon.innerText = '‚òÄÔ∏è';
            } else {
                document.body.classList.add('dark-mode');
                themeIcon.innerText = 'üåô';
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('marta_theme', isDark ? 'dark' : 'light');
            themeIcon.innerText = isDark ? 'üåô' : '‚òÄÔ∏è';
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    </script>
</body>
</html>
